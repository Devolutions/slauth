name: Rust

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose

  build_macos:
    runs-on: "macos-11"
    steps:
      - uses: actions/checkout@v2
        with:
          lfs: true
      - run: git lfs pull
      - name:  Install Rust
        shell: bash
        run: |
          set -e
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
          echo "##vso[task.setvariable variable=PATH;]$PATH:$HOME/.cargo/bin"
          source $HOME/.cargo/env

          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

          rustup target add aarch64-apple-ios
          rustup target add x86_64-apple-ios

      - name:  Build Rust Mac Arm64
        shell: bash
        run: |
          cargo build --release --target aarch64-apple-darwin

      - uses: actions/upload-artifact@v3
        with:
          name: artifact-staging
          path: |
            target/**

  build_windows:
    runs-on: "windows-latest"
    steps:
      - uses: actions/checkout@v2
        with:
          lfs: true
      - run: git lfs pull
      - name:  Install Rust
        shell: bash
        run: |
          rustup update

          rustup target add i686-pc-windows-msvc
          rustup target add x86_64-pc-windows-msvc

      - name:  Build Rust Windows 32
        shell: bash
        run: |
          cargo build --release --target i686-pc-windows-msvc
      
      - name:  Build Rust Windows 64
        shell: bash
        run: |
          cargo build --release --target x86_64-pc-windows-msvc

      - uses: actions/upload-artifact@v3
        with:
          name: artifact-staging
          path: |
            target/**